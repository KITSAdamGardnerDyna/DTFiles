#!/bin/bash
sudo useradd dynatrace
sudo groupadd dynatrace
sudo usermod -a -G dynatrace dynatrace
sudo yum update -y
sudo yum install nginx -y
sudo wget https://files.dynatrace.com/downloads/OnPrem/dynaTrace/7.0/7.0.0.2429/dynatrace-wsagent-7.0.0.2429-linux-x86-64.tar -P /opt
sudo tar -xvf /opt/dynatrace-wsagent-7.0.0.2429-linux-x86-64.tar
sudo /opt/dynatrace-wsagent-7.0.0.2429-linux-x64.sh
sudo mv /opt/dynatrace-7.0 /opt/dynatrace
sudo chown -R dynatrace:dynatrace /opt/dynatrace
sudo cp /opt/dynatrace/init.d/dynaTraceWebServerAgent /etc/init.d/dynaTraceWebServerAgent
sudo sed -i -e 's,DT_HOME="/opt/dynatrace-7.0",DT_HOME="/opt/dynatrace",g' /etc/init.d/dynaTraceWebServerAgent
sudo sed -i -e 's,DT_RUNASUSER=,DT_RUNASUSER=dynatrace,g' /etc/init.d/dynaTraceWebServerAgent
sudo sed -i -e 's,Name dtwsagent,Name nginx-test-agent-auto,g' /opt/dynatrace/agent/conf/dtwsagent.ini
sudo sed -i -e 's,Server localhost,Collector 52.56.116.81,g' /opt/dynatrace/agent/conf/dtwsagent.ini
sudo sed -i -e 's,daemon $nginx -c $NGINX_CONF_FILE,LD_PRELOAD=/opt/dynatrace/agent/lib64/libdtagent.so daemon $nginx -c $NGINX_CONF_FILE,g' /etc/init.d/nginx
sudo service dynaTraceWebServerAgent start
sudo service nginx stop
sudo service nginx start
